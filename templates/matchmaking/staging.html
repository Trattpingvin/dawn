{% extends "base.html" %}
{% load static %}
{% block CSS %}
    <link href="{% static 'css/matchmaking.css' %}" rel="stylesheet">
{% endblock CSS %}
{% block title %} Match Staging {% endblock %}

{% block main %}
    <script type="text/javascript">
        let chooseDay = function(day){
            $(".dayselect").each(function(index)
            {
                $(this).removeClass("selected");
            });
            $("#"+day).addClass("selected");
        };

        function Match(){
            this.players = new Array();
        };

        $(document).ready(function () {
            
            $(".dayselect").click(function (event) {
                chooseDay(event.target.id);
            });

            setupDragAndDrop();
            console.log("setup done");
        });

        let setupDragAndDrop = function()
        {
            let currentDropTarget = null;
            
            $("#trashcan").on('dropped', function(e, player)
            {
                player.remove();
            });

            $(".draggable").mousedown(function(event) {
                let currentObj = $("#"+(event.target.id));
                //if has class source, make a non-source copy instead
                let shiftX = event.clientX - currentObj.get(0).getBoundingClientRect().left;
                let shiftY = event.clientY - currentObj.get(0).getBoundingClientRect().top;

                currentObj.css({position : 'absolute'});
                
                document.body.append(currentObj); //what's the point of this line??

                moveAt(event.pageX, event.pageY);

                function moveAt(pageX, pageY) {
                    currentObj.css({
                        "left" : pageX - shiftX + 'px',
                        "top" : pageY - shiftY + 'px'
                    });
                }
                    
                

                function onMouseMove(event) {
                    moveAt(event.pageX, event.pageY);

                    currentObj.get(0).hidden = true;
                    let elemBelow = document.elementFromPoint(event.clientX, event.clientY);
                    currentObj.get(0).hidden = false;

                    if (!elemBelow) return;

                    let dropTargetBelow = elemBelow.closest('.droptarget');
                    if (currentDropTarget != dropTargetBelow) {
                        if (currentDropTarget) { // null when we were not over a droppable before this event
                            leaveDroppable(currentDropTarget);
                        }
                        currentDropTarget = dropTargetBelow;
                        if (currentDropTarget) { // null if we're not coming over a droppable now
                            // (maybe just left the droppable)
                            enterDroppable(currentDropTarget);
                        }
                    }
                }

                document.addEventListener('mousemove', onMouseMove);

                currentObj.mouseup(function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    currentObj.onmouseup = null;
                    if(currentDropTarget)
                    {
                        leaveDroppable(currentDropTarget);
                        $("#"+currentDropTarget.id).triggerHandler('dropped', currentObj);
                    }
                    
                    
                });

            });

            function enterDroppable(elem) {
                elem.style.background = '#d8d8d8';
            }

            function leaveDroppable(elem) {
                elem.style.background = '';
            }


        }
    </script>

    <div id="dayselectors">{% for day in days %}
        <button class="dayselect" id="{{ day }}">Day {{ day }}</button>
    {% endfor %}
    </div>
    <div class="big">
        <div class="matches">
            {% for match in matches %}
                <div class="droptarget" id="match{{ match }}"></div>
            {% endfor %}
        </div>
        <div class="stats">
            <button class="draggable" id="drag21">Drag me</button>
            <img src="{% static 'img/trashbin.png' %}" class="droptarget" id="trashcan" width="50" height="50">

        </div>

    </div>
    <button id="makematches">Add these matches to database</button>



{% endblock %}