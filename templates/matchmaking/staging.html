{% extends "base.html" %}
{% load static %}
{% block CSS %}
    <link href="{% static 'css/matchmaking.css' %}" rel="stylesheet">
{% endblock CSS %}
{% block title %} Match Staging {% endblock %}

{% block main %}
    <script type="text/javascript">
        let trattsGlobals = {
            idCount : 0
        }
        
        let chooseDay = function(day){
            $(".dayselect").each(function(index)
            {
                $(this).removeClass("selected");
            });
            $("#"+day).addClass("selected");
        }

        function addPlayerToMatch(player, match)
        {

        }

        function Match(){
            this.players = new Array();
        }

        function setupHandlers()
        {
            $("#trashcan").on('dropped', function(e, droppable)
            {
                droppable.remove();
            });

            $(".stagingmatch").on('dropped', function(e, droppable)
            {
                $(this).append(droppable);
                droppable.style.position = 'relative';
                droppable.style.left = 0;
                droppable.style.top = 0;
            });
        }

        let setupDragAndDrop = function()
        {
            let currentDropTarget = null;
            
            $(".draggable").mousedown(function(event) {
                let currentObj = $("#"+(event.target.id));
                if(currentObj.hasClass('dragsource'))
                {
                    currentObj = currentObj.clone(true, true);
                    currentObj.removeClass('dragsource');
                    currentObj.attr('id', event.target.id+"__"+trattsGlobals['idCount']);
                    trattsGlobals['idCount']++;

                }
                $('body').append(currentObj);
                let shiftX = currentObj.width()/2;
                let shiftY = currentObj.height()/2;

                currentObj.parent()
                currentObj.css({position : 'absolute'});

                moveAt(event.pageX, event.pageY);

                function moveAt(pageX, pageY) {
                    currentObj.css({
                        "left" : pageX - shiftX + 'px',
                        "top" : pageY - shiftY + 'px'
                    })
                       
                }
                    
                function onMouseMove(event) {
                    moveAt(event.pageX, event.pageY);

                    currentObj.get(0).hidden = true;
                    let elemBelow = document.elementFromPoint(event.clientX, event.clientY);
                    currentObj.get(0).hidden = false;

                    if (!elemBelow) return;

                    let dropTargetBelow = elemBelow.closest('.droptarget');
                    if (currentDropTarget != dropTargetBelow) {
                        if (currentDropTarget) { // null when we were not over a droppable before this event
                            leaveDroppable(currentDropTarget);
                        }
                        currentDropTarget = dropTargetBelow;
                        if (currentDropTarget) { // null if we're not coming over a droppable now
                            // (maybe just left the droppable)
                            enterDroppable(currentDropTarget);
                        }
                    }
                }

                document.addEventListener('mousemove', onMouseMove);

                currentObj.mouseup(function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    currentObj.onmouseup = null;
                    if(currentDropTarget)
                    {
                        leaveDroppable(currentDropTarget);
                        $("#"+currentDropTarget.id).triggerHandler('dropped', currentObj);
                    }
                    
                    
                });

            });

            function enterDroppable(elem) {
                elem.style.background = '#d8d8d8';
            }

            function leaveDroppable(elem) {
                elem.style.background = '';
            }
        }

        $(document).ready(function () {
            
            $(".dayselect").click(function (event) {
                chooseDay(event.target.id);
            });

            setupDragAndDrop();
            setupHandlers();
            console.log("setup done");
        });
    </script>

    <div id="dayselectors">{% for day in days %}
        <button class="dayselect" id="{{ day }}">Day {{ day }}</button>
    {% endfor %}
    </div>
    <div class="big">
        <div class="matches">
            {% for match in matches %}
                <div class="droptarget stagingmatch" id="match{{ match }}"></div>
            {% endfor %}
        </div>
        <div class="stats">
            <button class="draggable dragsource" id="drag21">Drag me</button>
            <img src="{% static 'img/trashbin.png' %}" class="droptarget" id="trashcan" width="50" height="50">

        </div>

    </div>
    <button id="makematches">Add these matches to database</button>



{% endblock %}